# Weightlifting Desktop

Linux-first tooling for authoring, validating, exporting, and reviewing weight training plans. The workspace bundles a GTK4/libadwaita desktop editor, a CLI companion, a metrics indexer, reusable core models, and file-based sync utilities built entirely in Rust.

The project targets modern Linux desktops and the XDG directory conventions.

## Highlights
- GTK4 editor for plan creation with autosave, MRU tracking, validation gates, and rich segment manipulation.
- Command-line interface (`comp`) that validates, persists, exports, and visualises plans through built-in chart specs.
- Metrics indexer that ingests session CSV logs and emits cached E1RM, volume, and PR series for charting.
- Shared `weightlifting-core` library that owns the v0.3 plan schema, export staging, chart builders, attachments, and path management.
- Hardened JSON schema validator with semantic guards supplied by `weightlifting-validate`.
- Scriptable inbox/outbox sync workflow (SSH or USB-FS) for shuttling plans to a device and pulling results back.

## Repository Layout
- `apps/editor-gtk/` – GTK4 + libadwaita plan editor (`weightlifting-editor` binary).
- `crates/core/` – shared models (`Plan`, `Segment`, etc.), versioning, export staging, chart builders, attachment logs, and XDG path helpers.
- `crates/validate/` – JSON schema + semantic validation service.
- `crates/cli/` – CLI tool (`comp`) for plan lifecycle management and chart generation.
- `crates/indexer/` – CSV parser, metric calculators, cache persistence, and indexing CLI.
- `scripts/sync.sh` – transport-agnostic inbox/outbox synchronisation helper.
- `tests/` – integration and performance tests (e.g. 500-item validation benchmark).
- `*.json` in the repo root – example plans, sprint fixtures, and minimal templates.

## Plan Data Model
- Plans follow the authoritative **Plan JSON v0.3** spec (`PLAN_SPEC.md`) with rich segment semantics (straight/RPE/percentage schemes, complexes, choose/rotate groups, timed work, comments, anchored prescriptions, intensifiers, and equipment policies).
- `dictionary` and `groups` define canonical exercise codes (pattern `PATTERN.IMPLEMENT[.VARIANT]`) and swap lists; the validator enforces consistency.
- Day objects carry optional goals, time caps, and equipment policies; segment types are encoded via `type` tags.
- Attachments are tracked in append-only JSONL via `MediaAttachmentWriter` for associating set video/photos.
- Plan versioning (`PlanVersion`, `VersionedPlan`, `PlanVersionManager`) supports draft → staged → promoted workflows with change manifests.

## Desktop Editor (`weightlifting-editor`)
- Built with GTK4/libadwaita; designed for wide displays with a canvas, inspector, navigator, and preview bar.
- Autosaves every 5 seconds into XDG state drafts, tracks unsaved changes, and persists MRU/last directory in `preferences.json`.
- Validation dialog (`PlanValidator`) runs before user-initiated save/export to block schema or semantic errors.
- Keyboard shortcuts (Ctrl+N/O/S, range selection with Shift, multi-select with Ctrl) and focused navigation for day/segment editing.
- Integrates with RecentManager so plans appear in the desktop shell’s recent documents.
- Sync dialog leverages `scripts/sync.sh` to send the active plan to a remote inbox over SSH or USB.
- Rebuild with `cargo run --release -p weightlifting-editor-gtk` or install the provided `.desktop`/PNG assets.

### Runtime Storage
`weightlifting-core::AppPaths` resolves to:
- `~/.local/share/weightlifting-desktop/` – published plans (`plans/<plan_id>/<version>.json`) and media attachments.
- `~/.local/state/weightlifting-desktop/` – draft copies (`drafts/<plan_id>.json`) and autosave state.
- `~/.cache/weightlifting-desktop/` – metrics cache (`metrics/*.json`) for charting and indexer output.

Ensure these directories exist automatically; the editor and CLI create them on demand.

## CLI Companion (`comp`)

```
cargo run -p weightlifting-cli -- <command> <subcommand> [flags]
```

### Plan Commands
- `plans validate [--in | --file path]` – schema + semantic validation. Prints JSON diagnostics to stdout and human summary to stderr. Exits non-zero when errors are present.
- `plans save [--in | --file path]` – persists JSON plans to the drafts directory, generating an ID from the plan name.
- `plans get --id PLAN_ID [--version 1.2.3]` – emits the stored plan JSON (defaults to the latest draft).
- `plans export --id PLAN_ID [--version 1.2.3] --mount /mnt/device [--dry-run]` – stages an export manifest, detects conflicts (duplicate IDs, exercise mismatches), and writes files into `<mount>/plans/<plan_id>/`.

### Chart Commands
The chart subcommands expect cached metrics generated by the indexer.

- `chart emit-spec --chart-type {e1rm|volume|pr|heatmap} [--exercise CODE] [--start-date YYYY-MM-DD] [--end-date YYYY-MM-DD] [--output spec.json]` – produces Vega-Lite JSON specifications via `BuiltinCharts`.
- `chart render ...` – placeholder for future headless rendering (currently exits with explainers).
- `chart export-csv --chart-type {e1rm|volume|pr} [filters] --output metrics.csv` – dumps CSV summaries (kg + lb columns).

Exit codes:
- `0` success, `2` recoverable plan/chart errors, `3` export conflicts, `4` missing paths.

## Metrics Indexer

```
cargo run -p weightlifting-indexer -- <command>
```

- `process --input path/to/sessions.csv [--force]` – parses session logs (v0.3 format), computes E1RM/volume/PR series, and caches them.
- `status` – reports entry counts, last update timestamp, and cache size.
- `clear` – removes cached metrics files.

The CSV parser enforces XOR reps/time, effort bounds, unit validation (`kg|lb|bw`), and other integrity checks. Cached JSON lives under `~/.cache/weightlifting-desktop/metrics/` and feeds the CLI chart commands and editor widgets.

## Sync Workflow
- `scripts/sync.sh` implements an inbox/outbox protocol with `.part` staging, SHA-256 verification, and archives. Transports: `ssh`, `usb-fs`, or automatic selection.
- Common flags: `--transport ssh`, `--local-root ~/.local/share/weightlifting-desktop`, `--remote-host user@host`, `--remote-root /srv/plans`, `--usb-mount /run/media/...`, `--dry-run 1`.
- Subcommands: `send`, `receive`, `setup-remote`, `discover-remote-dirs`, `auto`.
- See `docs/inbox-outbox.md` for directory semantics and expected behaviour on both sides.
- The GTK editor shells out to this script; override with `WEIGHTLIFTING_SYNC_SCRIPT` if needed.

## Getting Started

### Prerequisites
- Rust toolchain ≥ 1.75 (`rustup` recommended).
- System packages for GTK4 + libadwaita development, e.g. on Debian/Ubuntu:
  ```
  sudo apt install build-essential pkg-config libgtk-4-dev libadwaita-1-dev libglib2.0-dev
  ```
- Optional: `sha256sum`/`openssl`, `rsync`, `ssh` for sync flows; `sqlite3`/`rusqlite` dependencies are vendored with the `bundled` feature.

### Build & Run
- Build workspace: `cargo build --workspace --release`
- Launch editor: `cargo run --release -p weightlifting-editor-gtk`
- Validate a plan: `cargo run -p weightlifting-cli -- plans validate --file test_plan.json`
- Export to draft: `cat test_plan.json | cargo run -p weightlifting-cli -- plans save --in`
- Generate chart spec: `cargo run -p weightlifting-cli -- chart emit-spec --chart-type e1rm --output e1rm.json`
- Index session data: `cargo run -p weightlifting-indexer -- process --input logs/sessions.csv`

The repo ships with `test_plan.json`, `test_sprint1.json`, and other fixtures for experimentation.

## Development Notes
- Rust edition 2021 with workspace-level dependencies pinned in root `Cargo.toml`.
- Follow `rustfmt` defaults. Run `cargo fmt --all` and `cargo clippy --all-targets --all-features` before submitting patches.
- Tests: `cargo test --workspace` (includes validator performance test under `tests/`).
- GTK UI code lives under `apps/editor-gtk/src/`; canvases and widgets are decomposed into modules (`ui/components`, `canvas`, `operations`, `state`).
- Validation rules are centralised in `crates/validate/src/validator.rs`; extend semantic checks there alongside schema updates.
- Export manifests (`ExportStager`) and metrics calculators have unit tests in their respective crates—add coverage when modifying behaviour.

## Additional Resources
- `PLAN_SPEC.md` – full JSON schema narrative with examples and design goals.
- `weightlifting-editor.desktop` & `weightlifting.png` – launchers and branding assets for desktop integration.

Long live Linux
